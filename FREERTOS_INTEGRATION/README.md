# Integrating FreeRTOS into STM32F4 — Manual Approach

A step-by-step guide to manually integrating the FreeRTOS kernel into an STM32CubeIDE project for STM32F4xx microcontrollers — **without** relying on the CubeMX RTOS middleware plugin.

---

Most tutorials use CubeMX's built-in CMSIS-RTOS middleware, which abstracts away the internals. Manual integration gives you full visibility into how the kernel interacts with the hardware — which files it needs, how it hooks into ARM Cortex-M interrupts, and how memory management works under the hood. This knowledge transfers to any toolchain or IDE.

---

## Prerequisites

- STM32F4xx board (e.g., STM32F407VG Discovery, Nucleo-F446RE)
- STM32CubeIDE v1.13+
- FreeRTOS LTS source from [freertos.org](https://www.freertos.org)

---

## Step 1 — Download the FreeRTOS Kernel

Download and unzip the latest LTS release from [freertos.org](https://www.freertos.org). Navigate to the kernel source at:

```
FreeRTOSv202406.04-LTS/FreeRTOS-LTS/FreeRTOS/FreeRTOS-Kernel
```

The `portable/` directory inside the kernel contains architecture-specific port files. Since STM32F4 uses the ARM Cortex-M4F core with GCC, the relevant port is `portable/GCC/ARM_CM4F` use only this file deleting others.

---

## Step 2 — Create the Project and Add FreeRTOS Source

1. Create a new STM32 C project in STM32CubeIDE targeting your MCU.
2. Right-click the project → **New → Source Folder** → name it `ThirdParty`.
3. Inside `ThirdParty/`, create a folder named `FreeRTOS`.
4. From the downloaded kernel directory, copy the following into `ThirdParty/FreeRTOS/`:

```
ThirdParty/FreeRTOS/
├── include/              ← Kernel headers
├── portable/             ← Port layer + memory manager
├── tasks.c               ← Task scheduler
├── queue.c               ← Queue implementation
├── list.c                ← Internal linked list
├── timers.c              ← Software timers
├── event_groups.c        ← Event group synchronization
├── stream_buffer.c       ← Stream / message buffers
└── croutine.c            ← Co-routines (legacy, optional)
```

---

## Step 3 — Clean Up the Portable Directory

The `portable/` folder ships with ports for every supported architecture. Strip it down to only what this project needs.

**Keep only:**
- `portable/GCC/ARM_CM4F/` — delete all other folders inside `GCC/`
- `portable/MemMang/` — keep only `heap_4.c`, delete the rest

> **Choosing a different core?** Replace `ARM_CM4F` with the port matching your target: `ARM_CM3` for STM32F1, `ARM_CM7` for STM32H7, etc.

After cleanup:

```
portable/
├── GCC/
│   └── ARM_CM4F/
│       ├── port.c
│       └── portmacro.h
└── MemMang/
    └── heap_4.c
```

---

## Step 4 — Choosing a Heap Implementation

FreeRTOS ships five heap implementations. Only one should be included in the build.

| Heap | Use Case |
|---|---|
| `heap_1` | Never free memory. All objects created once at startup. Safest, most deterministic. |
| `heap_2` | Allows freeing but **no coalescence** — leads to fragmentation. Avoid in new designs. |
| `heap_3` | Wraps standard C `malloc()`/`free()` with thread safety. |
| `heap_4` | **Recommended.** Supports alloc + free with adjacent-block merging to prevent fragmentation. |
| `heap_5` | Same as heap_4 but spans multiple non-contiguous RAM regions (e.g., internal SRAM + external SDRAM). |

### Why Fragmentation Matters

```
Initial state:     [ A ][ B ][ C ][    Free    ]

Free B:            [ A ][Free][ C ][    Free    ]
Free A:            [Free][Free][ C ][    Free    ]

Without coalescence (heap_2):
  Two separate free blocks remain. A large allocation
  that fits in (A + B) combined space will FAIL.

With coalescence (heap_4):
  Adjacent free blocks are merged automatically:
                   [  Merged Free  ][ C ][    Free    ]
  Large allocation succeeds.
```

**Rule of thumb:** If your system creates or deletes tasks/queues at runtime, use `heap_4`.

---

## Step 5 — Exclude `sysmem.c`

FreeRTOS provides its own heap management through the selected heap file. The default `sysmem.c` generated by STM32CubeIDE conflicts with it.

1. In Project Explorer, locate `Src/sysmem.c`
2. Right-click → **Properties**
3. Under **C/C++ Build**, check **Exclude resource from build**
4. Apply and close

---

## Step 6 — Add Include Paths

The compiler needs to locate FreeRTOS headers.

1. Right-click project → **Properties**
2. **C/C++ Build → Settings → MCU GCC Compiler → Include Paths**
3. Add these paths:

```
"${workspace_loc:/${ProjName}/ThirdParty}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS/portable/GCC/ARM_CM4F}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS/include}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS/License}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS/portable}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS/portable/GCC}"
"${workspace_loc:/${ProjName}/ThirdParty/FreeRTOS/portable/MemMang}"
```

---
## Step 7 — Add `FreeRTOSConfig.h`

Every FreeRTOS project requires a `FreeRTOSConfig.h` that defines kernel parameters (tick rate, heap size, enabled features, etc.). Download a template from a [FreeRTOS demo project](https://github.com/FreeRTOS/FreeRTOS/tree/main/FreeRTOS/Demo) or adapt one from any STM32F4 example.

Place it inside `ThirdParty/FreeRTOS/`.
I have provided the file you can us it.

**Critical entries** — ensure these mappings are present to route hardware interrupts to the FreeRTOS kernel:

```c
#define vPortSVCHandler    SVC_Handler
#define xPortPendSVHandler PendSV_Handler
#define xPortSysTickHandler SysTick_Handler
```

---

## Step 8 — Configure CubeMX (.ioc)

Three configuration changes are required in the `.ioc` file to prevent conflicts between the HAL and FreeRTOS.

### 8.1 — Disable Auto-Generated IRQ Handlers

**Path:** `.ioc → NVIC → Code Generation`

Uncheck "Generate IRQ handler" for:

| Interrupt | FreeRTOS Uses It For |
|---|---|
| System service call via SWI (`SVC_Handler`) | Starting the first task |
| Pendable request for system service (`PendSV_Handler`) | Context switching between tasks |
| Time base: System tick timer (`SysTick_Handler`) | RTOS tick — timekeeping, delays, scheduling |

Without this, both CubeMX and FreeRTOS define these handlers, resulting in **"Multiple Definition" linker errors**.

### 8.2 — Change HAL Timebase to TIM6

**Path:** `.ioc → SYS → Timebase Source → TIM6`

Both FreeRTOS and the STM32 HAL need a periodic timer, but with conflicting priority requirements:

```
+--------------+------------+--------------+--------------------------------+
| Component    | Timer      | Priority     | Purpose                        |
+--------------+------------+--------------+--------------------------------+
| FreeRTOS     | SysTick    | Lowest       | Task scheduling, vTaskDelay()  |
| STM32 HAL    | TIM6       | Highest      | HAL_Delay(), timeouts          |
+--------------+------------+--------------+--------------------------------+
```

If both share SysTick, calling `HAL_Delay()` inside a FreeRTOS task can deadlock the system. TIM6 (a basic timer with no PWM/capture hardware) is the ideal low-resource candidate for the HAL timebase.

### 8.3 — Set NVIC Priority Grouping

**Path:** `.ioc → NVIC → Priority Group`

Set to: **4 bits for pre-emption priority, 0 bits for sub-priority**

FreeRTOS assumes all priority bits are pre-emption bits. Splitting bits between pre-emption and sub-priority causes `configMAX_SYSCALL_INTERRUPT_PRIORITY` to misinterpret interrupt levels — leading to corrupted kernel data structures and random Hard Faults.

**Regenerate code** after all `.ioc` changes.

---

## Step 9 — Add Required initial definations & Hooks in `main.c`

```c
/* USER CODE BEGIN Includes */
#include "FreeRTOS.h"
#include "task.h"
/* USER CODE END Includes */
```

```c
/* USER CODE BEGIN 4 */

/*
 * Called by FreeRTOS when a task exceeds its allocated stack.
 * Inspect pcTaskName in the debugger to identify the offending task.
 */
void vApplicationStackOverflowHook(TaskHandle_t xTask, char *pcTaskName)
{
    (void) xTask;
    (void) pcTaskName;
    for (;;);
}

/*
 * Called when pvPortMalloc() fails (heap exhausted).
 * Increase configTOTAL_HEAP_SIZE in FreeRTOSConfig.h if this fires.
 */
void vApplicationMallocFailedHook(void)
{
    for (;;);
}

/* USER CODE END 4 */
```

---

## Step 10 — Build and Verify

Build the project (`Ctrl+B`). A clean build with **0 errors** confirms the integration is complete.

### Quick Test

```c
void vTestTask(void *pvParameters)
{
    for (;;)
    {
        HAL_GPIO_TogglePin(GPIOA, GPIO_PIN_5);
        vTaskDelay(pdMS_TO_TICKS(500));
    }
}

int main(void)
{
    HAL_Init();
    SystemClock_Config();
    MX_GPIO_Init();

    xTaskCreate(vTestTask, "LED", 128, NULL, 1, NULL);
    vTaskStartScheduler();

    for (;;);
}
```

If the onboard LED blinks at ~1 Hz — FreeRTOS is running.

---

## Final Project Structure

```
Project/
├── Core/
│   ├── Inc/
│   └── Src/
│       └── main.c                     ← FreeRTOS includes + hook functions
├── ThirdParty/
│   └── FreeRTOS/
│       ├── include/                   ← Kernel headers
│       ├── portable/
│       │   ├── GCC/ARM_CM4F/          ← Cortex-M4F port (port.c, portmacro.h)
│       │   └── MemMang/heap_4.c       ← Dynamic memory manager
│       ├── FreeRTOSConfig.h           ← Kernel configuration
│       ├── tasks.c
│       ├── queue.c
│       ├── list.c
│       ├── timers.c
│       ├── event_groups.c
│       ├── stream_buffer.c
│       └── croutine.c
└── Drivers/                           ← HAL & CMSIS (auto-generated)
```

---

## Troubleshooting

| Symptom | Cause | Fix |
|---|---|---|
| `Multiple definition of SVC_Handler` | CubeMX still generating handlers | Uncheck IRQ generation (Step 8.1), regenerate |
| Hangs at `vTaskStartScheduler()` | Wrong NVIC priority grouping | Set 4-bit pre-emption (Step 8.3) |
| `HardFault` on first context switch | Handler mappings missing | Add `#define` mappings in `FreeRTOSConfig.h` (Step 7) |
| `HAL_Delay()` freezes inside a task | SysTick conflict | Change HAL timebase to TIM6 (Step 8.2) |
| `FreeRTOS.h: No such file` | Include paths not set | Verify paths (Step 6) |
| `pvPortMalloc` returns NULL | Heap exhausted | Increase `configTOTAL_HEAP_SIZE` |

---

## References

- [FreeRTOS Official Documentation](https://www.freertos.org/Documentation/RTOS_book.html)
- [FreeRTOS Kernel — GitHub](https://github.com/FreeRTOS/FreeRTOS-Kernel)
- [STM32CubeIDE User Guide](https://www.st.com/resource/en/user_manual/um2609-stm32cubeide-user-guide-stmicroelectronics.pdf)
